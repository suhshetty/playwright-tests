name: Visual Regression - VisualTesting (matrix + artifacts)

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * *' # nightly 12:00 AM IST

concurrency:
  group: visual-testing-${{ github.ref }}
  cancel-in-progress: true

jobs:
  list-files:
    name: Prepare matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create matrix (include array) from tests/VisualTesting/*.mjs
        id: create-matrix
        uses: actions/github-script@v6
        with:
          script: |
            const { execSync } = require('child_process');
            const path = require('path');

            let out = '';
            try {
              // list git-tracked .mjs files under tests/VisualTesting
              out = execSync("bash -lc \"git ls-files 'tests/VisualTesting/*.mjs'\"", { encoding: 'utf8' }).trim();
            } catch (e) {
              out = '';
            }

            const files = out ? out.split(/\r?\n/).map(s => s.trim()).filter(Boolean) : [];
            const include = files.map(f => ({ file: f, name: path.basename(f, '.mjs') }));

            // Return JSON object with include array (stringified)
            return JSON.stringify({ include });

  run-spec:
    name: Run Visual Spec: ${{ matrix.spec.name }}
    needs: list-files
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # use the include array produced by list-files
      matrix:
        spec: ${{ fromJson(needs.list-files.outputs.matrix).include }}
    timeout-minutes: 90

    env:
      SRC_SCREENSHOT_DIR: screenshots
      ARTIFACT_BASE: artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Prepare per-spec artifact directories
        run: |
          SPEC_FILE="${{ matrix.spec.file }}"
          SPEC_NAME="${{ matrix.spec.name }}"
          echo "SPEC_FILE=$SPEC_FILE" > spec.env
          echo "SPEC_NAME=$SPEC_NAME" >> spec.env
          mkdir -p "$ARTIFACT_BASE/screenshots/$SPEC_NAME"
          mkdir -p "$ARTIFACT_BASE/diffs/$SPEC_NAME"
        shell: bash

      - name: Debug - which spec will run
        run: |
          source spec.env
          echo "Running spec file: $SPEC_FILE"
          ls -la "$(dirname "$SPEC_FILE")" || true
        shell: bash

      - name: Run the exact Playwright spec
        run: |
          source spec.env
          npx playwright test "$SPEC_FILE" --reporter=list
        shell: bash

      - name: Collect screenshots into artifact folder
        run: |
          source spec.env
          if [ -d "$SRC_SCREENSHOT_DIR" ]; then
            cp -r "$SRC_SCREENSHOT_DIR"/. "artifacts/screenshots/$SPEC_NAME/" || true
          else
            echo "No screenshots folder ($SRC_SCREENSHOT_DIR) found"
          fi
        shell: bash

      - name: Collect diffs into artifact folder
        run: |
          source spec.env
          if [ -d "$SRC_SCREENSHOT_DIR/diffs" ]; then
            cp -r "$SRC_SCREENSHOT_DIR/diffs"/. "artifacts/diffs/$SPEC_NAME/" || true
          else
            echo "No diffs folder ($SRC_SCREENSHOT_DIR/diffs) found"
          fi
        shell: bash

      - name: Upload screenshots artifact (per-spec)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-screenshots-${{ matrix.spec.name }}
          path: artifacts/screenshots/${{ matrix.spec.name }}

      - name: Upload diffs artifact (per-spec)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diffs-${{ matrix.spec.name }}
          path: artifacts/diffs/${{ matrix.spec.name }}

  final-summary:
    name: Final summary
    needs: run-spec
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Done
        run: echo "All visual spec jobs completed (or were skipped). Check Artifacts for screenshots/diffs."
